import tkinter as tk
from tkinter import messagebox

class Livro:
    def __init__(self, titulo, autor):
        self.titulo = titulo
        self.autor = autor

    def __str__(self):
        return f"{self.titulo} por {self.autor}"


class No:
    def __init__(self, livro):
        self.livro = livro
        self.esquerda = None
        self.direita = None
        self.altura = 1


class ArvoreAVL:
    def altura(self, no):
        if not no:
            return 0
        return no.altura

    def rotacao_direita(self, z):
        y = z.esquerda
        T3 = y.direita

        y.direita = z
        z.esquerda = T3

        z.altura = 1 + max(self.altura(z.esquerda), self.altura(z.direita))
        y.altura = 1 + max(self.altura(y.esquerda), self.altura(y.direita))

        return y

    def rotacao_esquerda(self, z):
        y = z.direita
        T2 = y.esquerda

        y.esquerda = z
        z.direita = T2

        z.altura = 1 + max(self.altura(z.esquerda), self.altura(z.direita))
        y.altura = 1 + max(self.altura(y.esquerda), self.altura(y.direita))

        return y

    def fator_balanceamento(self, no):
        if not no:
            return 0
        return self.altura(no.esquerda) - self.altura(no.direita)

    def inserir(self, raiz, novo_livro):
        if not raiz:
            return No(novo_livro)

        if novo_livro.titulo < raiz.livro.titulo:
            raiz.esquerda = self.inserir(raiz.esquerda, novo_livro)
        else:
            raiz.direita = self.inserir(raiz.direita, novo_livro)

        raiz.altura = 1 + max(self.altura(raiz.esquerda), self.altura(raiz.direita))

        balanceamento = self.fator_balanceamento(raiz)

        if balanceamento > 1:
            if novo_livro.titulo < raiz.esquerda.livro.titulo:
                return self.rotacao_direita(raiz)
            else:
                raiz.esquerda = self.rotacao_esquerda(raiz.esquerda)
                return self.rotacao_direita(raiz)

        if balanceamento < -1:
            if novo_livro.titulo > raiz.direita.livro.titulo:
                return self.rotacao_esquerda(raiz)
            else:
                raiz.direita = self.rotacao_direita(raiz.direita)
                return self.rotacao_esquerda(raiz)

        return raiz

    def busca(self, raiz, titulo):
        if not raiz or raiz.livro.titulo == titulo:
            return raiz

        if titulo < raiz.livro.titulo:
            return self.busca(raiz.esquerda, titulo)
        else:
            return self.busca(raiz.direita, titulo)

    def menor_valor_no(self, no):
        atual = no
        while atual.esquerda:
            atual = atual.esquerda
        return atual

    def remover(self, raiz, titulo):
        if not raiz:
            return raiz

        if titulo < raiz.livro.titulo:
            raiz.esquerda = self.remover(raiz.esquerda, titulo)
        elif titulo > raiz.livro.titulo:
            raiz.direita = self.remover(raiz.direita, titulo)
        else:
            if raiz.esquerda is None:
                temp = raiz.direita
                raiz = None
                return temp
            elif raiz.direita is None:
                temp = raiz.esquerda
                raiz = None
                return temp

            temp = self.menor_valor_no(raiz.direita)
            raiz.livro = temp.livro
            raiz.direita = self.remover(raiz.direita, temp.livro.titulo)

        if raiz is None:
            return raiz

        raiz.altura = 1 + max(self.altura(raiz.esquerda), self.altura(raiz.direita))

        balanceamento = self.fator_balanceamento(raiz)

        if balanceamento > 1:
            if self.fator_balanceamento(raiz.esquerda) >= 0:
                return self.rotacao_direita(raiz)
            else:
                raiz.esquerda = self.rotacao_esquerda(raiz.esquerda)
                return self.rotacao_direita(raiz)

        if balanceamento < -1:
            if self.fator_balanceamento(raiz.direita) <= 0:
                return self.rotacao_esquerda(raiz)
            else:
                raiz.direita = self.rotacao_direita(raiz.direita)
                return self.rotacao_esquerda(raiz)

        return raiz

    def contagem_por_autor(self, raiz, autor):
        if not raiz:
            return 0

        contagem = 0
        if raiz.livro.autor == autor:
            contagem += 1

        contagem += self.contagem_por_autor(raiz.esquerda, autor)
        contagem += self.contagem_por_autor(raiz.direita, autor)

        return contagem

    def exibir_em_ordem_crescente(self, raiz):
        if not raiz:
            return []

        livros = []
        livros += self.exibir_em_ordem_crescente(raiz.esquerda)
        livros.append(raiz.livro)
        livros += self.exibir_em_ordem_crescente(raiz.direita)

        return livros

    def salvar_arvore_em_arquivo(self, raiz, nome_arquivo):
        with open(nome_arquivo, 'w') as arquivo:
            livros = self.exibir_em_ordem_crescente(raiz)
            for livro in livros:
                arquivo.write(f"{livro.titulo},{livro.autor}\n")

    def carregar_arvore_de_arquivo(self, nome_arquivo):
        raiz = None
        with open(nome_arquivo, 'r') as arquivo:
            linhas = arquivo.readlines()
            for linha in linhas:
                dados = linha.strip().split(',')
                livro = Livro(dados[0], dados[1])
                raiz = self.inserir(raiz, livro)
        return raiz


class BibliotecaGUI:
    def __init__(self, root):
        self.root = root
        self.root.title("Gerenciador de Biblioteca")

        self.arvore = ArvoreAVL()
        self.raiz = None

        # Interface
        self.frame = tk.Frame(root)
        self.frame.pack(padx=20, pady=20)

        # Entrada de dados
        tk.Label(self.frame, text="Título:").grid(row=0, column=0)
        self.titulo_entry = tk.Entry(self.frame)
        self.titulo_entry.grid(row=0, column=1)

        tk.Label(self.frame, text="Autor:").grid(row=1, column=0)
        self.autor_entry = tk.Entry(self.frame)
        self.autor_entry.grid(row=1, column=1)

        # Botões
        self.botao_inserir = tk.Button(self.frame, text="Inserir Livro", command=self.inserir_livro)
        self.botao_inserir.grid(row=2, columnspan=2, pady=10)

        self.botao_buscar = tk.Button(self.frame, text="Buscar por Autor", command=self.buscar_por_autor)
        self.botao_buscar.grid(row=3, columnspan=2, pady=5)

        self.botao_exibir = tk.Button(self.frame, text="Exibir Livros", command=self.exibir_livros)
        self.botao_exibir.grid(row=4, columnspan=2, pady=5)

        self.botao_salvar = tk.Button(self.frame, text="Salvar em Arquivo", command=self.salvar_em_arquivo)
        self.botao_salvar.grid(row=5, columnspan=2, pady=5)

        self.botao_carregar = tk.Button(self.frame, text="Carregar de Arquivo", command=self.carregar_de_arquivo)
        self.botao_carregar.grid(row=6, columnspan=2, pady=5)

    def inserir_livro(self):
        titulo = self.titulo_entry.get()
        autor = self.autor_entry.get()

        if titulo and autor:
            livro = Livro(titulo, autor)
            self.raiz = self.arvore.inserir(self.raiz, livro)
            messagebox.showinfo("Sucesso", "Livro inserido com sucesso!")
        else:
            messagebox.showwarning("Atenção", "Preencha título e autor.")

    def buscar_por_autor(self):
        autor = self.autor_entry.get()

        if autor:
            contagem = self.arvore.contagem_por_autor(self.raiz, autor)
            messagebox.showinfo("Busca por Autor", f"Quantidade de livros de {autor}: {contagem}")
        else:
            messagebox.showwarning("Atenção", "Digite o nome do autor.")

    def exibir_livros(self):
        livros_ordem_crescente = self.arvore.exibir_em_ordem_crescente(self.raiz)
        if livros_ordem_crescente:
            livros_str = "\n".join(str(livro) for livro in livros_ordem_crescente)
            messagebox.showinfo("Livros em Ordem Crescente", livros_str)
        else:
            messagebox.showinfo("Livros em Ordem Crescente", "Biblioteca vazia.")

    def salvar_em_arquivo(self):
        self.arvore.salvar_arvore_em_arquivo(self.raiz, "biblioteca.txt")
        messagebox.showinfo("Salvo", "Biblioteca salva em arquivo 'biblioteca.txt'.")

    def carregar_de_arquivo(self):
        self.raiz = self.arvore.carregar_arvore_de_arquivo("biblioteca.txt")
        messagebox.showinfo("Carregado", "Biblioteca carregada do arquivo 'biblioteca.txt'.")


if __name__ == "__main__":
    root = tk.Tk()
    app = BibliotecaGUI(root)
    root.mainloop()
